<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Fabric: Creating Fabric nodes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fabric
   &#160;<span id="projectnumber">0.2.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('node-config.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Creating Fabric nodes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Fabric nodes run relative to an <em>application home</em> directory, which contains the nodes' configuration and state. As a transitional naming mechanism, the application home can also contain naming information, specifying how to contact other Fabric nodes.</p>
<p>This guide demonstrates how to create and configure a Fabric node. As a running example, the node we create will be named <code>valinor</code> and will use <code>/opt/fabric</code> as the application home. The commands given are relative to the Fabric installation directory.</p>
<p>The name of the node can be any legal DNS hostname. This should ideally match the host machine's DNS name. However, with the transitional naming mechanism, a node's name need not have a DNS entry, nor is it required to match the host machine's DNS name.</p>
<h2>Create a certificate authority </h2>
<p>Fabric uses SSL to secure communication between nodes, so each node must have an X.509 certificate signed by a certificate authority (CA). While commercial CAs may be used, the Fabric distribution uses OpenSSL to provide a custom CA for convenience.</p>
<p>This Fabric distribution comes with a CA whose key pair and certificate have been pre-generated. Using this pre-generated CA avoids having to distribute the CA certificate across separate Fabric installations, but is insecure. For security, we recommend creating your own CA: </p><div class="fragment"><div class="line">$ bin/make-ca</div>
</div><!-- fragment --><p> By default, this creates a CA in <code>etc/ca</code> of the Fabric installation, overwriting any previously generated CA, and saves the CA certificate in <code>etc/ca/ca.crt</code>.</p>
<h2>Generate a key pair and certificate </h2>
<p>Each Fabric node needs a key pair and a signed X.509 certificate. These can be created in one of two ways. The <a class="el" href="node-config.html#make-node">first method</a> is provided for convenience. The <a class="el" href="node-config.html#genkey">second method</a> is suggested for better flexibility.</p>
<h3>Method 1: Using <code>make-node</code><a class="anchor" id="make-node"></a></h3>
<p>This method creates the key pair and certificate in a single step, using the CA in the Fabric installation to sign the certificate. </p><div class="fragment"><div class="line">$ bin/make-node --app-home /opt/fabric --name valinor</div>
</div><!-- fragment --><p> This creates a Java keystore <code>/opt/fabric/etc/keys/valinor.keystore</code> containing the node's private key and certificate.</p>
<p>Before importing the certificate into the node's keystore, the CA certificate will be displayed, and you will be asked whether it should be trusted. You can use the <code>--trust-ca-cert</code> option to automatically trust the CA certificate without prompting: </p><div class="fragment"><div class="line">$ bin/make-node --app-home /opt/fabric --name valinor --trust-ca-cert</div>
</div><!-- fragment --><h3>Method 2: Using <code>genkey</code><a class="anchor" id="genkey"></a></h3>
<p>This method creates the key pair and certificate in multiple steps, and is useful if you are using a commercial CA, or if the CA is on a separate Fabric installation.</p>
<p>Generate the key pair and the certificate-signing request (CSR). </p><div class="fragment"><div class="line">$ bin/genkey --app-home /opt/fabric --name valinor</div>
</div><!-- fragment --><p> This creates a Java keystore <code>/opt/fabric/etc/keys/valinor.keystore</code> containing the node's private key, and a CSR in <code>/opt/fabric/etc/csr/valinor.csr</code>.</p>
<p>Have the CSR signed by a CA. To sign using Fabric's CA facility: </p><div class="fragment"><div class="line">$ bin/ca-sign /opt/fabric/etc/csr/valinor.csr /tmp/valinor.crt</div>
</div><!-- fragment --><p> This creates a signed certificate in <code>/tmp/valinor.crt</code>.</p>
<p>Once you have a signed certificate, import it and the CA's certificate into the node's keystore: </p><div class="fragment"><div class="line">$ bin/<span class="keyword">import</span>-cert --keystore /opt/fabric/etc/keys/valinor.keystore \</div>
<div class="line">    --ca etc/ca/ca.crt /tmp/valinor.crt</div>
</div><!-- fragment --><p>Before importing the certificates, the CA certificate will be displayed, and you will be asked whether it should be trusted. You can use the <code>--trust-ca-cert</code> option to automatically trust the CA certificate without prompting: </p><div class="fragment"><div class="line">$ bin/<span class="keyword">import</span>-cert --keystore /opt/fabric/etc/keys/valinor.keystore \</div>
<div class="line">    --ca etc/ca/ca.crt /tmp/valinor.crt --trust-ca-cert</div>
</div><!-- fragment --><h2>Import other CA certificates </h2>
<p>If this node will be communicating with nodes whose certificates are signed by other CAs, you will also need to import the certificates of those CAs. </p><div class="fragment"><div class="line">$ bin/add-trusted-ca --keystore /opt/fabric/etc/keys/valinor.keystore \
    other-ca.crt</div>
</div><!-- fragment --><p>Before importing the certificate into the node's keystore, the CA certificate will be displayed, and you will be asked whether it should be trusted. You can use the <code>--no-prompt</code> option to automatically trust the CA certificate without prompting: </p><div class="fragment"><div class="line">$ bin/add-trusted-ca --no-prompt \</div>
<div class="line">    --keystore /opt/fabric/etc/keys/valinor.keystore \
    other-ca.crt</div>
</div><!-- fragment --><h2>Configure the node </h2>
<p>Our node <code>valinor</code> reads its configuration information from the files <code>etc/config.properties</code> and <code>etc/config/valinor.properties</code> in the application home. The first file, <code>config.properties</code>, specifies configuration values that are common to all nodes that share the application home. These values can be overridden in the node-specific file <code>valinor.properties</code>.</p>
<p>The Fabric distribution offers <code>etc/config/EXAMPLE.properties.in</code> as a template for a configuration file. Copy this to <code>/opt/fabric/etc/config/valinor.properties</code> and edit the file: </p><div class="fragment"><div class="line">$ cp etc/config/EXAMPLE.properties.in /opt/fabric/etc/config/valinor.properties</div>
<div class="line">$ vim /opt/fabric/etc/config/valinor.properties</div>
</div><!-- fragment --><p>Fabric nodes are configured using several parameters.</p>
<h3>Configuration parameters common to all nodes</h3>
<h4>Required</h4>
<ul>
<li><code>fabric.node.password</code> specifies the password for the node's keystore file.</li>
</ul>
<h4>Optional</h4>
<ul>
<li><code>fabric.node.keystore</code> specifies the name of the node's keystore file. By default, this is <code>NODE_NAME.keystore</code>. In our example, this is <code>valinor.keystore</code>. This file must be located in the <code>etc/keys</code> directory of the application home.</li>
<li><code>fabric.node.hostname</code> specifies the IP address or the DNS name of the node's host machine. By default, this is the same as the node's name.</li>
<li><code>fabric.node.fetchmanager.class</code> specifies the class for the dissemination layer implementation. Valid options include <code>fabric.dissemination.PastryFetchManager</code> and <code>fabric.dissemination.DummyFetchManager</code>. By default, <code>PastryFetchManager</code> is used.</li>
<li><code>fabric.worker.port</code> specifies the network port on which the node should listen for remote calls. The default worker port is 3372.</li>
<li><code>fabric.worker.adminPort</code> specifies the network port on which the worker should listen for administrative connections. The default administrative port is 3572.</li>
</ul>
<h3>Configuration parameters for worker nodes</h3>
<h4>Required</h4>
<ul>
<li><code>fabric.worker.homeStore</code> specifies the name of the store that will hold the worker's principal object.</li>
</ul>
<h3>Configuration parameters for storage nodes</h3>
<h4>Optional</h4>
<ul>
<li><code>fabric.store.port</code> it specifies the network port on which the store should listen for connections. The default store port is 3472.</li>
<li><code>fabric.store.db.class</code> specifies the class for the store's back-end database. Valid options include <code>fabric.store.db.BdbDB</code> and <code>fabric.store.db.MemoryDB</code>. The default is <code>fabric.store.db.BdbDB</code>.</li>
</ul>
<h2>Configure name resolution </h2>
<p>We must specify how other nodes can contact the node we just created. Ideally, this is done by adding a DNS entry with with an <code>A</code> (or <code>AAAA</code>) record containing the host machine's IP address and a <code>TXT</code> record specifying the node's network-port configuration. A store listening on port 3472 should have a <code>TXT</code> record <code>"fabric-store: 3472"</code>. Similarly, a worker listening on port 3372 should have a <code>TXT</code> record <code>"fabric-worker:
3372"</code>. (Default values are assumed if these records do not exist.) This use of the <code>TXT</code> record prevents the node's network-port configuration from being tied to the node's name (Ã  la <a href="http://example.com:8080/">http://example.com:8080/</a>) and allows the port configuration to change over time.</p>
<p>However, because this use of DNS is non-standard, we provide a transitional mechanism for resolving node names. To resolve a node, Fabric first looks in the <code>etc/config</code> directory of the application home. If it finds a <code>.properties</code> configuration file for the node, then it uses the configuration information found in that file. Otherwise, DNS is used.</p>
<p>When resolving a node, this transitional naming mechanism must be used if (a) the node's name does not match the host machine's DNS name, or (b) the node has a non-default port configuration and no corresponding <code>TXT</code> records in DNS.</p>
<p>To contact such a node, <code>valinor</code> must have a copy of the node's <code>.properties</code> configuration file in the <code>etc/config</code> directory of the application home. Similarly, if <code>valinor</code> relies on the transitional mechanism to be found, then its <code>.properties</code> configuration file must be copied to any node that will contact <code>valinor</code>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jul 8 2014 22:48:37 for Fabric by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.7 </li>
  </ul>
</div>
</body>
</html>
